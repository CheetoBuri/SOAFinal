<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - H·ªá th·ªëng Qu·∫£n l√Ω Qu√°n Cafe</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
            border-right: 3px solid #3498db;
        }

        .sidebar h2 {
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .menu-section {
            margin-bottom: 30px;
        }

        .menu-section h3 {
            font-size: 14px;
            color: #3498db;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .menu-item {
            background: #34495e;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: #3498db;
            border-left-color: #f39c12;
            transform: translateX(5px);
        }

        .menu-item.disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .menu-item.disabled:hover {
            background: #7f8c8d;
            border-left-color: transparent;
            transform: none;
        }

        .menu-item .name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .menu-item .price {
            color: #f39c12;
            font-size: 12px;
        }

        .menu-item .ingredients {
            font-size: 11px;
            color: #bdc3c7;
            margin-top: 4px;
        }

        .menu-item .status {
            font-size: 10px;
            margin-top: 4px;
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-block;
        }

        .menu-item .status.available {
            background: #27ae60;
            color: white;
        }

        .menu-item .status.unavailable {
            background: #e74c3c;
            color: white;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #3498db;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 28px;
        }

        .header-info {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
        }

        .container {
            display: flex;
            flex: 1;
            gap: 20px;
            padding: 20px;
            overflow: hidden;
        }

        .pos-section {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .pos-header {
            background: #3498db;
            color: white;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
        }

        .order-items {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .order-item {
            background: #ecf0f1;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #3498db;
            transition: all 0.3s;
        }

        .order-item-info {
            flex: 1;
        }

        .order-item-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .order-item-price {
            font-size: 14px;
            font-weight: bold;
            color: #3498db;
            margin-right: 15px;
        }

        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .remove-btn:hover {
            background: #c0392b;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #95a5a6;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .order-summary {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-top: 2px solid #3498db;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .summary-row.total {
            font-size: 18px;
            font-weight: bold;
            color: #f39c12;
            border-top: 1px solid #3498db;
            padding-top: 10px;
            margin-top: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-checkout {
            background: #27ae60;
            color: white;
        }

        .btn-checkout:hover {
            background: #229954;
        }

        .btn-clear {
            background: #e74c3c;
            color: white;
        }

        .btn-clear:hover {
            background: #c0392b;
        }

        .btn-disabled {
            background: #95a5a6;
            color: white;
            cursor: not-allowed;
        }

        .inventory-section {
            width: 350px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .inventory-header {
            background: #9b59b6;
            color: white;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
        }

        .inventory-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .inventory-item {
            background: #ecf0f1;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #95a5a6;
        }

        .inventory-item.green {
            border-left-color: #27ae60;
            background: #d5f4e6;
        }

        .inventory-item.yellow {
            border-left-color: #f39c12;
            background: #fff8e1;
        }

        .inventory-item.red {
            border-left-color: #e74c3c;
            background: #fadbd8;
        }

        .inv-item-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .inv-item-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .modal-row.total {
            font-size: 18px;
            font-weight: bold;
            color: #f39c12;
            border-top: 2px solid #3498db;
            padding-top: 12px;
            margin-top: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .modal-button.confirm {
            background: #27ae60;
            color: white;
        }

        .modal-button.confirm:hover {
            background: #229954;
        }

        .modal-button.cancel {
            background: #95a5a6;
            color: white;
        }

        .modal-button.cancel:hover {
            background: #7f8c8d;
        }

        .alert {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert.error {
            background: #fadbd8;
            color: #c0392b;
            border-left: 4px solid #e74c3c;
        }

        .alert.success {
            background: #d5f4e6;
            color: #27ae60;
            border-left: 4px solid #27ae60;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #3498db;
        }

        .loading.show {
            display: block;
        }

        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }

            .inventory-section {
                width: 100%;
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <!-- Sidebar Menu -->
    <div class="sidebar">
        <h2>‚òï MENU</h2>
        <div id="menuSidebar"></div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <h1>üçµ POS - Qu·∫£n l√Ω Qu√°n Cafe</h1>
            <div class="header-info">
                <div class="stat-item">
                    <div class="stat-value" id="orderCount">0</div>
                    <div class="stat-label">ƒê∆°n h√¥m nay</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalRevenue">0ƒë</div>
                    <div class="stat-label">T·ªïng thu</div>
                </div>
            </div>
        </div>

        <!-- Container -->
        <div class="container">
            <!-- POS Section -->
            <div class="pos-section">
                <div class="pos-header">üì¶ ƒê∆†N H√ÄNG HI·ªÜN T·∫†I</div>
                
                <div id="alertBox"></div>

                <div class="order-items" id="orderItems">
                    <div class="empty-state">
                        <div class="empty-state-icon">üõí</div>
                        <div>Ch∆∞a c√≥ m√≥n n√†o trong ƒë∆°n</div>
                    </div>
                </div>

                <div class="order-summary">
                    <div class="summary-row">
                        <span>S·ªë l∆∞·ª£ng:</span>
                        <span id="orderQty">0</span>
                    </div>
                    <div class="summary-row">
                        <span>T·ªïng ti·ªÅn:</span>
                        <span id="orderTotal">0ƒë</span>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-checkout" id="checkoutBtn" onclick="openCheckoutModal()">üí≥ THANH TO√ÅN</button>
                        <button class="btn btn-clear" id="clearBtn" onclick="clearOrder()">üîÑ H·ª¶Y ƒê∆†N</button>
                    </div>
                </div>
            </div>

            <!-- Inventory Section -->
            <div class="inventory-section">
                <div class="inventory-header">üìä T·ªíN KHO</div>
                <div class="inventory-list" id="inventoryList"></div>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üí≥ X√ÅC NH·∫¨N THANH TO√ÅN</div>
            <div class="modal-body" id="checkoutDetails"></div>
            <div class="modal-buttons">
                <button class="modal-button confirm" onclick="selectPaymentMethod('cash')">üí∞ Ti·ªÅn M·∫∑t</button>
                <button class="modal-button confirm" onclick="selectPaymentMethod('bank')">üè¶ Chuy·ªÉn Kho·∫£n</button>
                <button class="modal-button cancel" onclick="closeCheckoutModal()">‚úï H·ªßy</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚úì THANH TO√ÅN TH√ÄNH C√îNG</div>
            <div class="modal-body" id="successDetails"></div>
            <div class="modal-buttons">
                <button class="modal-button confirm" onclick="closeSuccessModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="color: #e74c3c;">‚ùå L·ªñI H·ªÜ TH·ªêNG</div>
            <div class="modal-body" id="errorDetails"></div>
            <div class="modal-buttons">
                <button class="modal-button cancel" onclick="closeErrorModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================

        function showAlert(message, type = 'error') {
            const alertBox = document.getElementById('alertBox');
            alertBox.innerHTML = `<div class="alert ${type} show">${message}</div>`;
            setTimeout(() => {
                alertBox.innerHTML = '';
            }, 3000);
        }

        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                let url = `${API_BASE}${endpoint}`;
                if (method === 'GET' && data) {
                    const params = new URLSearchParams(data).toString();
                    url += `?${params}`;
                }

                const response = await fetch(url, options);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || 'L·ªói API');
                }

                return result;
            } catch (error) {
                showAlert(error.message, 'error');
                throw error;
            }
        }

        // =====================================================
        // LOAD DATA
        // =====================================================

        async function loadMenu() {
            try {
                const menuData = await apiCall('/menu', 'GET', { simulated: true });
                const sidebar = document.getElementById('menuSidebar');
                let html = '';

                const sections = {
                    'C√† ph√™ ƒë∆°n': ['coffee_black'],
                    'C√† ph√™ s·ªØa': ['coffee_milk', 'bac_xiu'],
                    'ƒê·∫∑c bi·ªát': ['latte']
                };

                for (const [section, ids] of Object.entries(sections)) {
                    html += `<div class="menu-section"><h3>${section}</h3>`;

                    for (const id of ids) {
                        const item = menuData.find(m => m.id === id);
                        if (item) {
                            const statusClass = item.available ? 'available' : 'unavailable';
                            const statusText = item.available ? '‚úì C√ì S·∫¥N' : '‚ùå H·∫æT';
                            const clickHandler = item.available ? `addToOrder('${id}')` : '';
                            const disabledClass = item.available ? '' : 'disabled';

                            html += `
                                <div class="menu-item ${disabledClass}" onclick="${clickHandler}">
                                    <div class="name">${item.name}</div>
                                    <div class="price">${item.price.toLocaleString()} VNƒê</div>
                                    <div class="ingredients">${Object.entries(item.recipe)
                                        .map(([ing, amt]) => `${amt} ${ing}`)
                                        .join(', ')}</div>
                                    <span class="status ${statusClass}">${statusText}</span>
                                </div>
                            `;
                        }
                    }

                    html += '</div>';
                }

                sidebar.innerHTML = html;
            } catch (error) {
                console.error('Error loading menu:', error);
            }
        }

        async function loadInventory() {
            try {
                const inventory = await apiCall('/inventory');
                const list = document.getElementById('inventoryList');
                let html = '';

                for (const [id, ing] of Object.entries(inventory)) {
                    html += `
                        <div class="inventory-item ${ing.status}">
                            <div class="inv-item-name">
                                ${ing.name}
                                <span style="font-size: 10px; color: #7f8c8d;">
                                    ${ing.status === 'green' ? 'üü¢' : ing.status === 'yellow' ? 'üü°' : 'üî¥'}
                                </span>
                            </div>
                            <div class="inv-item-info">
                                <span>T·ªìn: <strong>${ing.quantity} ${ing.unit}</strong></span>
                                <span>Min: 2 ${ing.unit}</span>
                            </div>
                        </div>
                    `;
                }

                list.innerHTML = html;
            } catch (error) {
                console.error('Error loading inventory:', error);
            }
        }

        async function loadOrder() {
            try {
                const order = await apiCall('/order');
                const orderItems = document.getElementById('orderItems');
                const orderQty = document.getElementById('orderQty');
                const orderTotal = document.getElementById('orderTotal');

                if (order.order.length === 0) {
                    orderItems.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üõí</div>
                            <div>Ch∆∞a c√≥ m√≥n n√†o trong ƒë∆°n</div>
                        </div>
                    `;
                    orderQty.textContent = '0';
                    orderTotal.textContent = '0ƒë';
                } else {
                    let html = '';
                    let totalQty = 0;

                    for (const item of order.order) {
                        totalQty += item.quantity;
                        // B·∫°n c·∫ßn l·∫•y t√™n v√† gi√° t·ª´ menu
                        html += `
                            <div class="order-item">
                                <div class="order-item-info">
                                    <div class="order-item-name" id="item-${item.menu_id}-name"></div>
                                    <div>x${item.quantity}</div>
                                </div>
                                <div class="order-item-price" id="item-${item.menu_id}-price"></div>
                                <button class="remove-btn" onclick="removeFromOrder('${item.menu_id}')">X√≥a</button>
                            </div>
                        `;
                    }

                    orderItems.innerHTML = html;

                    // C·∫≠p nh·∫≠t t√™n v√† gi√°
                    const menu = await apiCall('/menu');
                    for (const item of order.order) {
                        const menuItem = menu.find(m => m.id === item.menu_id);
                        if (menuItem) {
                            document.getElementById(`item-${item.menu_id}-name`).textContent = menuItem.name;
                            document.getElementById(`item-${item.menu_id}-price`).textContent = 
                                `${(menuItem.price * item.quantity).toLocaleString()}ƒë`;
                        }
                    }

                    orderQty.textContent = totalQty;
                    orderTotal.textContent = `${order.total.toLocaleString()}ƒë`;
                }

                // Reload menu ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i available
                await loadMenu();
            } catch (error) {
                console.error('Error loading order:', error);
            }
        }

        async function loadStatistics() {
            try {
                const stats = await apiCall('/statistics');
                document.getElementById('orderCount').textContent = stats.orders_today;
                document.getElementById('totalRevenue').textContent = 
                    `${stats.revenue_today.toLocaleString()}ƒë`;
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // =====================================================
        // ORDER FUNCTIONS
        // =====================================================

        async function addToOrder(menuId) {
            try {
                await apiCall(`/order/add?menu_id=${menuId}`, 'POST');
                showAlert('‚úì ƒê√£ th√™m v√†o ƒë∆°n', 'success');
                await loadOrder();
                await loadInventory();
            } catch (error) {
                console.error('Error adding to order:', error);
            }
        }

        async function removeFromOrder(menuId) {
            try {
                await apiCall(`/order/remove?menu_id=${menuId}`, 'POST');
                showAlert('‚úì ƒê√£ x√≥a kh·ªèi ƒë∆°n', 'success');
                await loadOrder();
                await loadInventory();
            } catch (error) {
                console.error('Error removing from order:', error);
            }
        }

        async function clearOrder() {
            if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n?')) return;

            try {
                await apiCall('/order/clear', 'POST');
                showAlert('‚úì ƒê√£ h·ªßy ƒë∆°n', 'success');
                await loadOrder();
                await loadInventory();
            } catch (error) {
                console.error('Error clearing order:', error);
            }
        }

        // =====================================================
        // PAYMENT FUNCTIONS
        // =====================================================

        function openCheckoutModal() {
            const orderQty = document.getElementById('orderQty');
            if (orderQty.textContent === '0') {
                showAlert('‚ùå ƒê∆°n h√†ng tr·ªëng', 'error');
                return;
            }

            const orderTotal = document.getElementById('orderTotal').textContent;
            const checkoutDetails = document.getElementById('checkoutDetails');
            checkoutDetails.innerHTML = `
                <div class="modal-row">
                    <span>S·ªë l∆∞·ª£ng:</span>
                    <span>${orderQty.textContent}</span>
                </div>
                <div class="modal-row">
                    <span>T·ªïng ti·ªÅn:</span>
                    <span>${orderTotal}</span>
                </div>
                <div class="modal-row total">
                    <span>Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</span>
                </div>
            `;

            document.getElementById('checkoutModal').style.display = 'block';
        }

        function closeCheckoutModal() {
            document.getElementById('checkoutModal').style.display = 'none';
        }

        async function selectPaymentMethod(method) {
            try {
                const response = await apiCall('/payment', 'POST', { method });
                
                const successDetails = document.getElementById('successDetails');
                const methodText = method === 'cash' ? 'üí∞ Ti·ªÅn M·∫∑t' : 'üè¶ Chuy·ªÉn Kho·∫£n';
                
                successDetails.innerHTML = `
                    <div class="modal-row">
                        <span>Ph∆∞∆°ng th·ª©c:</span>
                        <span>${methodText}</span>
                    </div>
                    <div class="modal-row">
                        <span>Th·ªùi gian:</span>
                        <span>${new Date().toLocaleTimeString('vi-VN')}</span>
                    </div>
                    <div class="modal-row">
                        <span style="color: #27ae60; font-weight: bold;">‚úì Thanh to√°n th√†nh c√¥ng!</span>
                    </div>
                `;

                closeCheckoutModal();
                document.getElementById('successModal').style.display = 'block';

                // Reload m·ªçi th·ª© sau khi thanh to√°n
                setTimeout(async () => {
                    await loadOrder();
                    await loadInventory();
                    await loadStatistics();
                }, 1000);
            } catch (error) {
                console.error('Error processing payment:', error);
            }
        }

        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }

        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
        }

        // =====================================================
        // INITIALIZATION
        // =====================================================

        window.addEventListener('load', async () => {
            await loadMenu();
            await loadOrder();
            await loadInventory();
            await loadStatistics();

            // Reload m·ªói 5 gi√¢y
            setInterval(async () => {
                await loadInventory();
                await loadStatistics();
            }, 5000);

            // Close modal khi click b√™n ngo√†i
            window.addEventListener('click', (event) => {
                const modals = ['checkoutModal', 'successModal', 'errorModal'];
                for (const modalId of modals) {
                    const modal = document.getElementById(modalId);
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                }
            });
        });
    </script>
</body>
</html>
